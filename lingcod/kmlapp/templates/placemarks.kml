{% extends "style.kml" %}
{% load rest_uid array_uid mpa_uid absurl absolute_media_url %}

{% block folders_and_placemarks %}
{% for array_nameid, a in shapes %}
{% if a.array.id and use_network_links %}
    <NetworkLink id="{{a.array.get_absolute_url}}">
    <Style>
	    <ListStyle>
          <ItemIcon>
            <state>open closed</state>                
            {% if a.array.sharing_groups.all %}
            <href>{% absolute_media_url %}common/images/array-shared.png</href>
            {% else %}
            <href>{% absolute_media_url %}common/images/array.png</href>
            {% endif %}
          </ItemIcon>
        </ListStyle>	       
    </Style>
     <name>{{ a.array.name }}</name>
     <open>0</open>
     <visibility>0</visibility>
     <atom:link rel="marinemap.update_form" title="Edit {{a.array.name}}" mm:icon="/path/to/icon.jpg" mm:model="{% array_uid %}" href="{% url array_update_form pk=a.array.id %}" />
     <atom:link rel="marinemap.share_form" title="Share" mm:icon="/path/to/icon.jpg" mm:model="{% array_uid %}" href="{% url sharing-object-form object_type=array_ctid pk=a.array.pk %}" />
     <atom:link rel="marinemap.copy" title="Copy" mm:icon="/path/to/icon.jpg" mm:model="{% array_uid %}" href="{% url array-copy pk=a.array.pk %}" />
     <atom:link rel="self" title="{{ a.array.name }}" mm:model="{% array_uid %}" mm:pk="{{ a.array.pk }}" href="{{ a.array.get_absolute_url }}" />
     <atom:link rel="alt" href="{% url kmlapp-array-kmz input_array_id=a.array.id,session_key=session_key %}" title="as kmz (Google Earth)" type="application/vnd.google-earth.kmz" />

     {% url array_shapefile a.array.id as array_shapefile %}
     {% if array_shapefile %}
     <atom:link rel="alt" href="{% url array_shapefile a.array.id %}" title="as shapefile" type="application/shapefile" />
     {% endif %}

     <atom:link rel="alt" href="{% url staticmap-show "default" %}?array={{a.array.id}}&amp;attachment=true" title="as image (PNG)" type="application/shapefile" />
     <Link>
      <href>{% absurl kmlapp-array-kmz input_array_id=a.array.id,session_key=session_key %}</href>
     </Link>
    {% url array_summary_excel a.array.pk as array_summary_excel %}
    {# {% if user.is_staff and array_summary_excel %} #}
		<atom:link rel="alt" href="{{array_summary_excel}}" title="Array Spreadsheet" type="application/ms-excel" />
    {# {% endif %} #}
	
    </NetworkLink>
{% else %}
    {% if use_array_folders %}
        <Folder>
            <name>{{ a.array.name }}</name>
            {% if a.array.id %}
            <Style>
                <ListStyle>
                <ItemIcon>
                    <state>open closed</state>                
                    {% if a.array.sharing_groups.all %}
                    <href>{% absolute_media_url %}common/images/array-shared.png</href>
                    {% else %}
                    <href>{% absolute_media_url %}common/images/array.png</href>
                    {% endif %}
                </ItemIcon>
                </ListStyle>	       
            </Style>
            <atom:link rel="marinemap.update_form" title="Edit {{a.array.name}}" mm:icon="/path/to/icon.jpg" mm:model="{% array_uid %}" href="{% url array_update_form pk=a.array.id %}" />
            <atom:link rel="self" title="{{ a.array.name }}" mm:model="{% array_uid %}" mm:pk="{{ a.array.pk }}" href="{{ a.array.get_absolute_url }}" />
            <atom:link rel="alt" href="{% url kmlapp-array-kmz input_array_id=a.array.id,session_key=session_key %}" title="as kmz (Google Earth)" type="application/vnd.google-earth.kmz" />

            {% url array_shapefile a.array.id as array_shapefile %}
            {% if array_shapefile %}
            <atom:link rel="alt" href="{{ array_shapefile }}" title="as shapefile" type="application/shapefile" />
            {% endif %}

            {% url array_summary_excel a.array.pk as array_summary_excel %}
            {# {% if user.is_staff and array_summary_excel %} #}
                <atom:link rel="alt" href="{{array_summary_excel}}" title="Array Spreadsheet" type="application/ms-excel" />
            {# {% endif %} #}

            <atom:link rel="marinemap.share_form" title="Share" mm:icon="/path/to/icon.jpg" mm:model="{% array_uid %}" href="{% url sharing-object-form object_type=array_ctid,pk=a.array.pk %}" />
            <atom:link rel="marinemap.copy" title="Copy" mm:icon="/path/to/icon.jpg" mm:model="{% array_uid %}" href="{% url array-copy pk=a.array.pk %}" />
            <atom:link rel="alt" href="{% url staticmap-show "default" %}?array={{a.array.id}}&amp;attachment=true" title="as image (PNG)" type="application/shapefile" />
            <visibility>1</visibility>
            {% else %}
            <visibility>0</visibility>
            {% endif %}
            <open>0</open>
    {% endif %}

    {% for mpa in a.mpas %} 
    <Placemark id="{{mpa.get_absolute_url}}">
        <name>{{ mpa.name }}</name>
        {% if mpa.designation %}
        <styleUrl>#{{ mpa.designation.acronym }}-style</styleUrl>
        {% else %}
        <styleUrl>#defaultstyle</styleUrl>
        {% endif %}
        <Style>
    	    <ListStyle>
              <ItemIcon>
                <state>open closed</state>                
                {% if mpa.sharing_groups.all %}
                <href>{% absolute_media_url %}common/images/mpa-{{mpa.designation.acronym}}-shared.png</href>
                {% else %}
                <href>{% absolute_media_url %}common/images/mpa-{{mpa.designation.acronym}}.png</href>
                {% endif %}
              </ItemIcon>
            </ListStyle>	       
	    </Style>
        <atom:link rel="marinemap.update_form" title="Edit" mm:icon="/path/to/icon.jpg" mm:model="{% mpa_uid %}" href="{% url mpa_update_form pk=mpa.pk %}" />
        <atom:link rel="marinemap.share_form" title="Share" mm:icon="/path/to/icon.jpg" mm:model="{% mpa_uid %}" href="{% url sharing-object-form object_type=mpa_ctid,pk=mpa.pk %}" />
        <atom:link rel="marinemap.copy" title="Copy" mm:icon="/path/to/icon.jpg" mm:model="{% mpa_uid %}" href="{% url mpa-copy pk=mpa.pk %}" />
        <atom:link rel="self" title="{{mpa.name}}" mm:model="{% mpa_uid %}" mm:pk="{{ mpa.pk }}" href="{{mpa.get_absolute_url}}" />
        <atom:link rel="alt" href="{% url kmlapp-mpa-kmz input_mpa_id=mpa.id,session_key=session_key %}" title="as kmz (Google Earth)" type="application/vnd.google-earth.kmz" />

        {% url mpa_shapefile mpa.id as mpa_shapefile %}
        {% if mpa_shapefile %}
        <atom:link rel="alt" href="{{ mpa_shapefile }}" title="as shapefile" type="application/shapefile" />
        {% endif %}

        <atom:link rel="alt" href="{% url staticmap-show "default" %}?mpas={{mpa.id}}&amp;attachment=true" title="as image (PNG)" type="application/shapefile" />
        <visibility>1</visibility>
        <ExtendedData>
            <Data name="mpaid"><value>{{ mpa.id }}</value></Data>
            <Data name="name"><value>{{ mpa.name }}</value></Data>
              {% if mpa.user.first_name and mpa.user.last_name %} 
            <Data name="user"><value>{{ mpa.user.first_name }} {{ mpa.user.last_name }}</value></Data>
              {% else %}
            <Data name="user"><value>{{ mpa.user.username }}</value></Data>
              {% endif %}
            <Data name="created"><value>{{ mpa.date_created }}</value></Data>
            <Data name="modified"><value>{{ mpa.date_modified|date:"M d,Y" }}</value></Data>
            <Data name="area"><value>{{ mpa.geometry_final.area }}</value></Data>
            <Data name="designation"><value>{{ mpa.designation }}</value></Data>
        </ExtendedData>
        <MultiGeometry>
        {{ mpa.centroid_kml|safe }} 
        {{ mpa.kml|safe }} 
        </MultiGeometry>
    </Placemark>
    {% endfor %}

    {% if a.array.id and use_network_links %}
    {% else %}
        {% if use_array_folders %}
        </Folder>
        {% endif %}
    {% endif %}

{% endif %}
{% endfor %}
{% endblock %}
